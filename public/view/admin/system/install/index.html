<!DOCTYPE html>
<html lang="en">

<head>
    <title>安装程序</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <link rel="shortcut icon" href="{__A-assets__}/img/favicon.ico">
    <link rel="stylesheet" href="{__A-assets__}/mdui-v1.0.2/css/mdui.min.css" />
    <link rel="stylesheet" href="{__A-assets__}/base.css" />

    <style>
        .mask-xs {
            max-height: 180px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mask-md {
            max-height: 640px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide {
            display: none;
        }

        .mdui-card-primary-subtitle a {
            color: #ff4081;
            position: relative;
            display: inline-block;
            overflow: hidden;
            text-decoration: none;
            vertical-align: top;
            outline: 0;
        }
    </style>
</head>

<body class="mdui-theme-primary-indigo mdui-theme-layout-light mdui-theme-accent-pink">
    <div class="mdui-container-fluid">
        <div class="mdui-card" style="margin: 5%;">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-col-md-5 mask-md mdui-hidden-sm-down">
                    <img style="height: 680px;" src="https://img1.imgtp.com/2023/05/05/rsGxwTe7.gif">
                    <div class="mdui-card-media-covered mdui-p-x-2  ">
                        <div class="mdui-card-primary">
                            <div class="mdui-card-primary-title">LoveCards</div>
                            <div class="mdui-card-primary-subtitle">
                                Crafted with <a href="{$systemVer.Url}">{$systemVer.Name}</a> © 2023 time Made by 吃纸怪.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mdui-col-xs-12 mdui-col-md-6 mask-xs mdui-hidden-md-up">
                    <img src="https://img1.imgtp.com/2023/05/05/rsGxwTe7.gif" style="width: 100%;">
                    <div class="mdui-card-media-covered mdui-p-x-2  ">
                        <div class="mdui-card-primary">
                            <div class="mdui-card-primary-title">LoveCards</div>
                            <div class="mdui-card-primary-subtitle">
                                Crafted with <a href="{$systemVer.Url}">{$systemVer.Name}</a> © 2023 time Made by 吃纸怪.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mdui-col-xs-12 mdui-col-md-7">
                    <div class="mdui-p-x-5 mdui-p-t-4">
                        <div id="tab" class="mdui-tab mdui-tab-full-width">
                            <a id="tab1" class="mdui-ripple">版本详情</a>
                            <a id="tab2" class="mdui-ripple" disabled>配置数据库</a>
                            <!-- <a id="tab3" class="mdui-ripple" disabled>创建账户</a> -->
                            <a id="tab3" class="mdui-ripple" disabled>完成安装</a>
                        </div>
                    </div>

                    <div class="mdui-p-x-5 mdui-p-t-5">
                        <div id="tab-e1">
                            <div class="mdui-typo">
                                <h4>欢迎使用LoveCards</h4>
                                <p>当前版本：<kbd>{$systemVer.VerS}/{$systemVer.Ver}</kbd></p>
                                <p>项目主页：<a href="https://lovecards.cn/">lovecards.cn</a></p>
                                <p>QQ交流群：<a href="{$systemVer.QGroupUrl}">801235342</a></p>
                            </div>
                        </div>
                        <div id="tab-e2" class="hide">
                            <div class="mdui-textfield">
                                <label class="mdui-textfield-label">数据库服务器</label>
                                <textarea id="formDataHostname" class="mdui-textfield-input">localhost</textarea>
                            </div>
                            <div class="mdui-textfield">
                                <label class="mdui-textfield-label">数据库用户名</label>
                                <textarea id="formDataUsername" class="mdui-textfield-input"></textarea>
                            </div>
                            <div class="mdui-textfield">
                                <label class="mdui-textfield-label">数据库密码</label>
                                <textarea id="formDataPassword" class="mdui-textfield-input"></textarea>
                            </div>
                            <div class="mdui-textfield">
                                <label class="mdui-textfield-label">数据库端口</label>
                                <textarea id="formDataHostport" class="mdui-textfield-input">3306</textarea>
                            </div>
                            <div class="mdui-textfield">
                                <label class="mdui-textfield-label">数据库名</label>
                                <textarea id="formDataDatabase" class="mdui-textfield-input"></textarea>
                            </div>
                        </div>
                        <!-- <div id="tab-e3" class="hide">
                            创建账户
                        </div> -->
                        <div id="tab-e3" class="hide">
                            <div class="mdui-typo">
                                <h4 class="mdui-text-center">安装完成</h4>
                                <p>
                                <ul>
                                    <li>管理地址：/admin</li>
                                    <li>门户首页：/index</li>
                                    <li>默认账户：admin admin</li>
                                </ul>
                                </p>
                                <!-- <blockquote>如果您安装并使用了该程序，将默认您阅读并同意该条款<a
                                        href="http://fatda.cn/index.php/archives/8/">《Fatda用户条款》</a></blockquote> -->
                            </div>
                        </div>
                    </div>

                    <div class="mdui-p-x-5 mdui-p-t-5 mdui-p-b-4">
                        <button id="btnPrev" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent"
                            style="visibility: hidden;">上一步</button>
                        <button id="btnNext"
                            class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent mdui-float-right">下一步</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{__A-assets__}/jquery-3.6.0/jquery.min.js"></script>
    <script src="{__A-assets__}/mdui-v1.0.2/js/mdui.min.js"></script>
    <script src="{__A-assets__}/jquery_lazyload-1.9.7/jquery.lazyload.js"></script>
    <script src="{__A-assets__}/jquery-cookie-1.4.1/jquery.cookie.min.js"></script>
    <script src="{__A-assets__}/base.js"></script>
    <script src="{__A-assets__}/public.js"></script>
    <script>
        //Base
        var currentDate = new Date();
        var currentYear = currentDate.getFullYear();
        //更新版权
        $('.mdui-card-primary-subtitle').html('Crafted with <a href="{$systemVer.Url}">{$systemVer.Name}</a> © ' + currentYear + ' Made by 吃纸怪.')

        //初始化
        var nowTab = 1;
        var inst = new mdui.Tab('#tab');
        //页面动态
        var FunTabControl = (state) => {
            nowTab = nowTab + state;
            //显示下一个Tab
            $('#tab' + nowTab).attr("disabled", false);
            $('#tab-e' + nowTab).attr('class', '');
            //隐藏当前Tab
            $('#tab' + (nowTab - state)).attr("disabled", true);
            $('#tab-e' + (nowTab - state)).attr('class', 'hide');
        }
        //下一页
        var btnNext = () => {
            if (nowTab < $('#tab').children().length - 1) {
                //显示上一页btn
                $('#btnPrev').attr('style', '');
                //锁定其他Tab
                FunTabControl(1);
                //更新进度条
                inst.next();
                if (nowTab == $('#tab').children().length - 1) {
                    //隐藏上一页btn
                    $('#btnPrev').remove();
                    $('#btnNext').attr('class', 'mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent mdui-btn-block').text('进入你的领域！');
                }
            } else {
                //console.log('安装完成');
            }
        }
        //上一页
        var btnPrev = () => {
            if (nowTab > 1) {
                //锁定其他Tab
                FunTabControl(-1);
                //更新进度条
                inst.prev();
                if (nowTab == 1) {
                    //隐藏上一页btn
                    $('#btnPrev').attr('style', 'visibility: hidden;');
                }
            } else {
                //console.log('第一页了');
            }
        }

        //操作
        $('#btnNext').click(function () {
            //数据库tab
            if (nowTab == 2) {
                //数据库导入
                var data = {
                    'hostname': $('#formDataHostname').val(),
                    'database': $('#formDataDatabase').val(),
                    'username': $('#formDataUsername').val(),
                    'password': $('#formDataPassword').val(),
                    'hostport': $('#formDataHostport').val(),
                };
                var result = apiAjax0a(data, apiSystemInstallSetDbConfig, 'POST', false);
                //console.log(result['r']);
                if (result['r']['ec'] == 200) {
                    //成功
                    mdui.snackbar({
                        message: '数据库配置成功',
                        position: 'left-top'
                    });
                    btnNext();
                } else if (result['r']['ec'] == 201) {
                    //选择跳过
                    mdui.snackbar({
                        position: 'left-top',
                        message: 'msg&nbsp;:&nbsp;' + result['r']['msg'],
                        buttonText: '跳过',
                        onButtonClick: function () {
                            btnNext();
                        }
                    });
                } else {
                    //报错
                    mdui.snackbar({
                        position: 'left-top',
                        message: 'msg&nbsp;:&nbsp;' + result['r']['msg'] + '<br>code&nbsp;:&nbsp;' + result['r']['ec'],
                    });
                }
            } else if (nowTab == 3) {
                var result = apiAjax0a([], apiSystemInstallSetInstallLock, 'POST', false);
                if (result['r']['ec'] == 200) {
                    //成功
                    mdui.snackbar({
                        message: '安装记录生成成功',
                        position: 'left-top'
                    });
                    jumpUrl('/', 0);
                } else {
                    //报错
                    mdui.snackbar({
                        position: 'left-top',
                        message: 'msg&nbsp;:&nbsp;' + result['r']['msg'] + '<br>code&nbsp;:&nbsp;' + result['r']['ec'],
                    });
                }
            } else {
                //正常下一步
                btnNext();
            }
        })
        $('#btnPrev').click(function () {
            btnPrev();
        })
    </script>

</body>